<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TNS Engagement Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
  :root { --bg:#0b0c10; --card:#111317; --text:#e8e8e8; --muted:#a1a1aa; --accent:#60a5fa; --line:#1f2430; }
  body { margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); color:var(--text); }
  .wrap { max-width: 960px; margin: 24px auto; padding: 16px; }
  .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
  h1 { font-size:22px; margin:0 0 12px; }
  p.muted { color:var(--muted); margin:0 0 16px; }
  label { display:block; font-weight:600; margin:12px 0 6px; }
  select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f1217; color:var(--text); }
  textarea { min-height:88px; resize:vertical; }
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px; }
  .actions { display:flex; gap:10px; margin-top:16px; }
  button { cursor:pointer; border:1px solid var(--line); background:var(--accent); color:#0b1220; font-weight:700; padding:10px 14px; border-radius:12px; }
  button.secondary { background:transparent; color:var(--text); }
  .hidden { display:none; }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
  table { width:100%; border-collapse:collapse; }
  th, td { text-align:left; padding:8px 6px; border-bottom:1px solid var(--line); }
  .badge { border-radius:8px; padding:4px 8px; display:inline-block; }
  .tfoot-bold td { font-weight:700; border-top:2px solid var(--line); }
  .warn { color:#f59e0b; font-size:12px; margin-top:6px; }

  @media (max-width: 600px) {
    h1 { font-size: 18px; }
    body { font-size: 14px; }
    .wrap { padding: 8px; }
    .card { padding: 12px; }
    select, textarea { font-size: 14px; padding: 8px; }
    button { flex: 1; font-size: 14px; padding: 8px; }
    .actions { flex-direction: column; }
    table { font-size: 13px; }
  }
  @media (max-width: 900px) {
    h1 { font-size: 20px; }
    .wrap { padding: 12px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" style="margin-bottom:12px; padding:12px 16px; display:flex; gap:8px; align-items:center;">
    <button id="navLog" class="secondary">Log</button>
    <button id="navDash" class="secondary">Dashboard</button>
    <span class="pill" id="status" style="margin-left:auto;">Ready</span>
  </div>

  <!-- Log -->
  <div class="card" id="logCard">
    <h1>Engagement Tracker</h1>
    <p class="muted">Use 0–3 where 3 = consistently engaged.</p>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <form id="gform" method="POST" target="hidden_iframe"
      action="https://docs.google.com/forms/d/e/1FAIpQLScQKrGvj614QZdjZBDBMdoPHR2hJT15fNJwBekfvdWUaiX8jA/formResponse">
      <div class="grid">
        <div>
          <label for="student">Student</label>
          <select id="student" name="entry.600087882" required>
            <option value="" selected>—</option>
            <option>Tony</option><option>Cameron</option><option>Sela</option>
            <option>Miles</option><option>Juni</option><option>Lucy</option>
            <option>Kaden</option><option>Quinn</option><option>Micah</option>
            <option>Lia</option><option>Phoenix</option><option>Uriah</option>
          </select>
        </div>

        <!-- Class (now populated from sheet / fallbacks) -->
        <div>
          <label for="class">Class</label>
          <select id="class" name="entry.740434656" required>
            <option value="" selected>—</option>
          </select>
          <div id="classWarn" class="warn hidden">Couldn’t load class list — using fallback.</div>
        </div>

        <div>
          <label>Preparedness (0–3)</label>
          <select name="entry.1686702304"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>
        <div>
          <label>Participation (0–3)</label>
          <select name="entry.1636498973"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>
        <div>
          <label>Work Completion (0–3)</label>
          <select name="entry.1072802712"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>
        <div>
          <label>Collaboration (0–3)</label>
          <select name="entry.1339133543"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>
        <div>
          <label>Reflection/Growth (0–3)</label>
          <select name="entry.476397369"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>

        <div style="grid-column: 1 / -1;">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" name="entry.155155169" placeholder="E.g., led the discussion; needs reminder on materials"></textarea>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Submit</button>
        <button type="button" class="secondary" id="clearBtn">Clear</button>
      </div>
    </form>

    <div id="confirm" class="hidden" style="margin-top:12px;">
      <span class="badge" style="background:#22c55e; color:#052814;">✅ Logged</span>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="card hidden" id="dashCard">
    <h1>Dashboard</h1>
    <p class="muted">Colors: green ≥ 2.5, yellow 1.5–2.49, red &lt; 1.5</p>

    <div style="margin-bottom:12px;">
      <label for="classFilter">Filter by Class:</label>
      <select id="classFilter">
        <option value="">All Classes</option>
      </select>
    </div>

    <div style="overflow:auto;">
      <table>
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
        <tfoot><tr id="tfoot" class="tfoot-bold"></tr></tfoot>
      </table>
    </div>
    <div class="actions" style="margin-top:16px;">
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>
  </div>
</div>

<script>
  // === DATA ENDPOINTS ===
  // Preferred (GViz)
  const SHEET_ID = "1mTF8cLllg818vc9A8qJ51UqHucreV1ZQl6OYK9tdkP0";
  const RESPONSES_GID = "825728935";  // Form Responses tab
  const CLASSES_SHEET = "Classes";    // Optional tab with a single column "Class"

  const GVIZ_RESPONSES = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${RESPONSES_GID}`;
  const GVIZ_CLASSES   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CLASSES_SHEET)}`;

  // Fallback (Publish-to-web CSV)
  const PUB_RESPONSES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU-MQprepvmDGEvjNqdc7oxx7ojpJrVUtqljBnUT1m0S8dJL9tsvJ1k_sxt1cZw4G1baY3gSCebTZU/pub?output=csv";

  // Final fallback: your five classes (never blank)
  const DEFAULT_CLASSES = [
    "Post-Apocalyptic Fiction",
    "Dollars & Sense: Real-World Math for Life",
    "Wilde Lore and Living Earth",
    "Local Haunts",
    "Wild Wellness: Foraging & Survival Shelter Building"
  ];

  async function fetchCSV(urls) {
    let lastErr = null;
    for (const u of urls) {
      try {
        const res = await fetch(u, { cache: 'no-store', mode: 'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        if (!text.trim()) throw new Error('Empty CSV');
        return text;
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error('All sources failed');
  }

  function parseCSV(csv) {
    return csv
      .split(/\r?\n/)
      .filter(r => r.trim().length)
      .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
  }

  function findHeader(headers, names) {
    const norm = s => (s||'').toString().trim().toLowerCase();
    const H = headers.map(norm);
    for (const name of names) {
      const i = H.indexOf(norm(name));
      if (i !== -1) return i;
    }
    return -1;
  }

  function requireIndex(idx, label) {
    if (idx === -1) throw new Error('Missing column: ' + label);
  }

  function distinctSortedTrimmed(values) {
    const seen = new Map();
    for (const v of values) {
      const t = (v || '').trim();
      if (!t) continue;
      const k = t.toLowerCase();
      if (!seen.has(k)) seen.set(k, t);
    }
    return [...seen.values()].sort((a,b)=>a.localeCompare(b));
  }

  // === CLASS LIST POPULATION ===
  const classSelect = document.getElementById('class');
  const classFilter = document.getElementById('classFilter');
  const classWarn = document.getElementById('classWarn');

  async function getClasses() {
    // 1) Try dedicated "Classes" tab
    try {
      const csv = await fetchCSV([GVIZ_CLASSES]);
      const rows = parseCSV(csv);
      const head = rows[0];
      const iClass = findHeader(head, ['Class']);
      requireIndex(iClass, 'Class');
      const list = distinctSortedTrimmed(rows.slice(1).map(r => r[iClass]));
      if (list.length) return list;
    } catch(_) { /* ignore and fall through */ }

    // 2) Fall back to responses sheet
    try {
      const csv = await fetchCSV([GVIZ_RESPONSES, PUB_RESPONSES]);
      const rows = parseCSV(csv);
      const head = rows[0];
      const iClass = findHeader(head, ['Class']);
      requireIndex(iClass, 'Class');
      const list = distinctSortedTrimmed(rows.slice(1).map(r => r[iClass]));
      if (list.length) return list;
    } catch(_) { /* ignore and fall through */ }

    // 3) Final fallback
    return DEFAULT_CLASSES.slice();
  }

  async function populateClassControls() {
    const classes = await getClasses();
    const currentFormSel = classSelect.value;
    const currentFilterSel = classFilter.value;

    classSelect.innerHTML = '<option value="" selected>—</option>' + classes.map(c => `<option>${c}</option>`).join('');
    classFilter.innerHTML = '<option value="">All Classes</option>' + classes.map(c => `<option>${c}</option>`).join('');

    if (classes.includes(currentFormSel)) classSelect.value = currentFormSel;
    if (currentFilterSel && classes.includes(currentFilterSel)) classFilter.value = currentFilterSel;

    classWarn.classList.toggle('hidden', classes !== DEFAULT_CLASSES);
  }

  // === DASHBOARD ===
  const statusPill = document.getElementById('status');
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const tfoot = document.getElementById('tfoot');

  function tint(v) {
    if (v === null) return '';
    if (v < 1.5) return 'background:#2b0b0b; color:#ef4444;';
    if (v < 2.5) return 'background:#3a2500; color:#f59e0b;';
    return 'background:#052814; color:#22c55e;';
  }

  async function loadDashboard() {
    try {
      statusPill.textContent = 'Loading…';
      await populateClassControls();

      const csv = await fetchCSV([GVIZ_RESPONSES, PUB_RESPONSES]);
      const rows = parseCSV(csv);
      if (rows.length < 2) { statusPill.textContent = 'No data'; return; }

      const head = rows[0];
      const data = rows.slice(1).filter(r => r.some(c => (c || '').trim() !== ''));

      const iStudent = findHeader(head, ['Student','Student Name']);
      const iClass = findHeader(head, ['Class']);
      requireIndex(iStudent, 'Student'); requireIndex(iClass, 'Class');

      const cats = ['Preparedness','Participation','Work Completion','Collaboration','Reflection/Growth'];
      const catAliases = {
        'Preparedness': ['Preparedness'],
        'Participation': ['Participation'],
        'Work Completion': ['Work Completion','Work completion'],
        'Collaboration': ['Collaboration'],
        'Reflection/Growth': ['Reflection/Growth','Reflection / Growth','Reflection- Growth'],
      };
      const iCats = cats.map(c => findHeader(head, catAliases[c]));
      iCats.forEach((idx,k)=>requireIndex(idx,cats[k]));

      // Filter by class
      const sel = classFilter.value;
      const filtered = sel ? data.filter(r => (r[iClass]||'').trim() === sel) : data;

      // Aggregate
      const byStudent = new Map();
      const sums = Array(iCats.length).fill(0);
      const counts = Array(iCats.length).fill(0);

      for (const r of filtered) {
        const name = (r[iStudent]||'').trim();
        if (!name) continue;
        if (!byStudent.has(name)) byStudent.set(name, { s:Array(iCats.length).fill(0), c:Array(iCats.length).fill(0) });
        const rec = byStudent.get(name);
        iCats.forEach((col,i)=>{
          const v = Number((r[col]||'').toString().trim());
          if (!Number.isNaN(v)) { rec.s[i]+=v; rec.c[i]++; sums[i]+=v; counts[i]++; }
        });
      }

      const rowsOut = [...byStudent.entries()].map(([student,rec])=>{
        const avgs = rec.s.map((s,i)=> rec.c[i] ? s/rec.c[i] : null);
        const used = avgs.filter(x=>x!==null);
        const overall = used.length ? used.reduce((a,b)=>a+b,0)/used.length : null;
        return { student, avgs, overall };
      }).sort((a,b)=> (a.overall ?? Infinity) - (b.overall ?? Infinity));

      const classAvgs = sums.map((s,i)=> counts[i] ? s/counts[i] : null);
      const usedC = classAvgs.filter(x=>x!==null);
      const classOverall = usedC.length ? usedC.reduce((a,b)=>a+b,0)/usedC.length : null;

      // Render
      thead.innerHTML=''; tbody.innerHTML=''; tfoot.innerHTML='';
      ['Student',...cats,'Overall'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; thead.appendChild(th); });

      rowsOut.forEach(r=>{
        const tr=document.createElement('tr');
        function td(t,style=''){ const c=document.createElement('td'); c.textContent=t; if(style) c.style=style; tr.appendChild(c);}
        td(r.student);
        r.avgs.forEach(v=>td(v==null?'—':(Math.round(v*100)/100).toFixed(2),tint(v)));
        td(r.overall==null?'—':(Math.round(r.overall*100)/100).toFixed(2),'font-weight:700; '+tint(r.overall));
        tbody.appendChild(tr);
      });

      const trF=document.createElement('tr');
      function tdf(t,style=''){ const c=document.createElement('td'); c.textContent=t; if(style) c.style=style; trF.appendChild(c); }
      const label = sel ? `Class Average (${sel})` : 'Class Average (All)';
      tdf(label);
      classAvgs.forEach(v=>tdf(v==null?'—':(Math.round(v*100)/100).toFixed(2),tint(v)));
      tdf(classOverall==null?'—':(Math.round(classOverall*100)/100).toFixed(2),'font-weight:700; '+tint(classOverall));
      tfoot.appendChild(trF);

      statusPill.textContent='Ready';
    } catch(e) {
      console.error(e);
      statusPill.textContent='Error';
      alert('Dashboard error: ' + (e.message || e));
    }
  }

  // === UI WIRING ===
  const navLog = document.getElementById('navLog');
  const navDash = document.getElementById('navDash');
  const logCard = document.getElementById('logCard');
  const dashCard = document.getElementById('dashCard');
  const confirmEl = document.getElementById('confirm');
  const form = document.getElementById('gform');
  const clearBtn = document.getElementById('clearBtn');
  const refreshBtn = document.getElementById('refreshBtn');

  form.addEventListener('submit', () => {
    statusPill.textContent = 'Submitting…'; confirmEl.classList.add('hidden');
    const iframe = document.getElementById('hidden_iframe');
    const onLoad = () => { statusPill.textContent = 'Submitted'; confirmEl.classList.remove('hidden'); iframe.removeEventListener('load', onLoad); form.reset(); populateClassControls().catch(()=>{}); };
    iframe.addEventListener('load', onLoad);
  });

  clearBtn.addEventListener('click', () => { form.reset(); confirmEl.classList.add('hidden'); statusPill.textContent = 'Ready'; populateClassControls().catch(()=>{}); });

  navLog.addEventListener('click', () => { dashCard.classList.add('hidden'); logCard.classList.remove('hidden'); });
  navDash.addEventListener('click', () => { logCard.classList.add('hidden'); dashCard.classList.remove('hidden'); loadDashboard(); });
  refreshBtn.addEventListener('click', loadDashboard);
  classFilter.addEventListener('change', loadDashboard);

  // Prime class dropdowns on page load
  (async () => { await populateClassControls(); })();
</script>
</body>
</html>
