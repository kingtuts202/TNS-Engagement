<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TNS Engagement Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
  :root { --bg:#0b0c10; --card:#111317; --text:#e8e8e8; --muted:#a1a1aa; --accent:#60a5fa; --line:#1f2430; }
  body { margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); color:var(--text); }
  .wrap { max-width: 960px; margin: 24px auto; padding: 16px; }
  .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
  h1 { font-size:22px; margin:0 0 12px; }
  p.muted { color:var(--muted); margin:0 0 16px; }
  label { display:block; font-weight:600; margin:12px 0 6px; }
  select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f1217; color:var(--text); }
  textarea { min-height:88px; resize:vertical; }
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px; }
  .actions { display:flex; gap:10px; margin-top:16px; }
  button { cursor:pointer; border:1px solid var(--line); background:var(--accent); color:#0b1220; font-weight:700; padding:10px 14px; border-radius:12px; }
  button.secondary { background:transparent; color:var(--text); }
  .hidden { display:none; }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
  table { width:100%; border-collapse:collapse; }
  th, td { text-align:left; padding:8px 6px; border-bottom:1px solid var(--line); }
  .badge { border-radius:8px; padding:4px 8px; display:inline-block; }
  .tfoot-bold td { font-weight:700; border-top:2px solid var(--line); }

  /* Responsive tweaks */
  @media (max-width: 600px) {
    h1 { font-size: 18px; }
    body { font-size: 14px; }
    .wrap { padding: 8px; }
    .card { padding: 12px; }
    select, textarea { font-size: 14px; padding: 8px; }
    button { flex: 1; font-size: 14px; padding: 8px; }
    .actions { flex-direction: column; }
    table { font-size: 13px; }
  }
  @media (max-width: 900px) {
    h1 { font-size: 20px; }
    .wrap { padding: 12px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- Top Nav -->
  <div class="card" style="margin-bottom:12px; padding:12px 16px; display:flex; gap:8px; align-items:center;">
    <button id="navLog" class="secondary">Log</button>
    <button id="navDash" class="secondary">Dashboard</button>
    <span class="pill" id="status" style="margin-left:auto;">Ready</span>
  </div>

  <!-- Log card -->
  <div class="card" id="logCard">
    <h1>Engagement Tracker</h1>
    <p class="muted">Use 0–3 where 3 = consistently engaged.</p>

    <!-- Hidden iframe to avoid navigating away on submit -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <!-- Posts directly to your Google Form -->
    <form id="gform" method="POST" target="hidden_iframe"
      action="https://docs.google.com/forms/d/e/1FAIpQLScQKrGvj614QZdjZBDBMdoPHR2hJT15fNJwBekfvdWUaiX8jA/formResponse">
      <div class="grid">
        <!-- Student -->
        <div>
          <label for="student">Student</label>
          <select id="student" name="entry.600087882" required>
            <option value="" selected>—</option>
            <option>Tony</option><option>Cameron</option><option>Sela</option>
            <option>Miles</option><option>Juni</option><option>Lucy</option>
            <option>Kaden</option><option>Quinn</option><option>Micah</option>
            <option>Lia</option><option>Phoenix</option><option>Uriah</option>
          </select>
        </div>

        <!-- Class -->
        <div>
          <label for="class">Class</label>
          <select id="class" name="entry.740434656" required>
            <option value="" selected>—</option>
            <option>Wilde Lore and Living Earth</option>
            <option>Humanities</option>
            <option>STEM</option>
            <option>Advisory</option>
            <option>Art</option>
            <option>Music</option>
            <option>PE</option>
          </select>
        </div>

        <!-- Preparedness -->
        <div>
          <label>Preparedness (0–3)</label>
          <select name="entry.1686702304"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>

        <!-- Participation -->
        <div>
          <label>Participation (0–3)</label>
          <select name="entry.1636498973"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>

        <!-- Work Completion -->
        <div>
          <label>Work Completion (0–3)</label>
          <select name="entry.1072802712"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>

        <!-- Collaboration -->
        <div>
          <label>Collaboration (0–3)</label>
          <select name="entry.1339133543"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>

        <!-- Reflection/Growth -->
        <div>
          <label>Reflection/Growth (0–3)</label>
          <select name="entry.476397369"><option value=""></option><option>0</option><option>1</option><option>2</option><option>3</option></select>
        </div>

        <!-- Notes -->
        <div style="grid-column: 1 / -1;">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" name="entry.155155169" placeholder="E.g., led the discussion; needs reminder on materials"></textarea>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Submit</button>
        <button type="button" class="secondary" id="clearBtn">Clear</button>
      </div>
    </form>

    <div id="confirm" class="hidden" style="margin-top:12px;">
      <span class="badge" style="background:#22c55e; color:#052814;">✅ Logged</span>
    </div>
  </div>

  <!-- Dashboard card -->
  <div class="card hidden" id="dashCard">
    <h1>Dashboard</h1>
    <p class="muted">Colors: green ≥ 2.5, yellow 1.5–2.49, red &lt; 1.5</p>

    <!-- Class filter -->
    <div style="margin-bottom:12px;">
      <label for="classFilter">Filter by Class:</label>
      <select id="classFilter">
        <option value="">All Classes</option>
      </select>
    </div>

    <div style="overflow:auto;">
      <table>
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
        <tfoot><tr id="tfoot" class="tfoot-bold"></tr></tfoot>
      </table>
    </div>
    <div class="actions" style="margin-top:16px;">
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>
  </div>
</div>

<script>
  // ---- DASHBOARD DATA SOURCE ----
  // Preferred GViz endpoint (stable for embedding)
  const SHEET_ID = "1mTF8cLllg818vc9A8qJ51UqHucreV1ZQl6OYK9tdkP0";
  const GID = "825728935";
  const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;

  // Fallback to your published CSV
  const PUB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU-MQprepvmDGEvjNqdc7oxx7ojpJrVUtqljBnUT1m0S8dJL9tsvJ1k_sxt1cZw4G1baY3gSCebTZU/pub?output=csv";

  async function fetchCSVText() {
    const sources = [
      { name: "GViz", url: GVIZ_URL },
      { name: "Published CSV", url: PUB_URL },
    ];
    let lastErr = null;
    for (const src of sources) {
      try {
        console.log(`[fetchCSV] Trying ${src.name}: ${src.url}`);
        const res = await fetch(src.url, { cache: 'no-store', mode: 'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const text = await res.text();
        if (!text || !text.trim()) throw new Error('Empty CSV response');
        console.log(`[fetchCSV] ${src.name} OK, first 200 chars:`, text.slice(0, 200));
        statusPill.textContent = `Loaded (${src.name})`;
        return text;
      } catch (e) {
        console.warn(`[fetchCSV] ${src.name} failed:`, e);
        lastErr = e;
      }
    }
    throw lastErr || new Error('All CSV sources failed');
  }

  const navLog = document.getElementById('navLog');
  const navDash = document.getElementById('navDash');
  const logCard = document.getElementById('logCard');
  const dashCard = document.getElementById('dashCard');
  const statusPill = document.getElementById('status');
  const confirmEl = document.getElementById('confirm');
  const form = document.getElementById('gform');
  const clearBtn = document.getElementById('clearBtn');
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const tfoot = document.getElementById('tfoot');
  const classFilter = document.getElementById('classFilter');
  const refreshBtn = document.getElementById('refreshBtn');

  // Submit handler
  form.addEventListener('submit', () => {
    statusPill.textContent = 'Submitting…';
    confirmEl.classList.add('hidden');
    const iframe = document.getElementById('hidden_iframe');
    const onLoad = () => {
      statusPill.textContent = 'Submitted';
      confirmEl.classList.remove('hidden');
      iframe.removeEventListener('load', onLoad);
      form.reset();
    };
    iframe.addEventListener('load', onLoad);
  });

  clearBtn.addEventListener('click', () => {
    form.reset();
    confirmEl.classList.add('hidden');
    statusPill.textContent = 'Ready';
  });

  navLog.addEventListener('click', () => { dashCard.classList.add('hidden'); logCard.classList.remove('hidden'); });
  navDash.addEventListener('click', () => { logCard.classList.add('hidden'); dashCard.classList.remove('hidden'); loadDashboard(); });
  refreshBtn.addEventListener('click', loadDashboard);
  classFilter.addEventListener('change', loadDashboard);

  function tint(v) {
    if (v === null) return '';
    if (v < 1.5) return 'background:#2b0b0b; color:#ef4444;';
    if (v < 2.5) return 'background:#3a2500; color:#f59e0b;';
    return 'background:#052814; color:#22c55e;';
  }

  function findHeader(headers, names) {
    const norm = h => (h || '').toString().trim().toLowerCase();
    const H = headers.map(norm);
    for (const name of names) {
      const i = H.indexOf(norm(name));
      if (i !== -1) return i;
    }
    return -1;
  }

  function requireIndex(idx, label) {
    if (idx === -1) throw new Error('Missing column: ' + label);
  }

  async function loadDashboard() {
    try {
      statusPill.textContent = 'Loading…';

      const csv = await fetchCSVText();

      const rows = csv
        .split(/\r?\n/)
        .filter(r => r.trim().length)
        .map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));

      if (rows.length < 2) { statusPill.textContent = 'No data'; return; }

      const head = rows[0];
      const data = rows.slice(1).filter(r => r.some(c => (c || '').trim() !== ''));

      // Required columns (case-insensitive)
      const iStudent = findHeader(head, ['Student','Student Name']);
      const iClass = findHeader(head, ['Class']);
      requireIndex(iStudent, 'Student');
      requireIndex(iClass, 'Class');

      const cats = ['Preparedness','Participation','Work Completion','Collaboration','Reflection/Growth'];
      const catAliases = {
        'Preparedness': ['Preparedness'],
        'Participation': ['Participation'],
        'Work Completion': ['Work Completion','Work completion'],
        'Collaboration': ['Collaboration'],
        'Reflection/Growth': ['Reflection/Growth','Reflection / Growth','Reflection- Growth'],
      };
      const iCats = cats.map(c => findHeader(head, catAliases[c]));
      iCats.forEach((idx, k) => requireIndex(idx, cats[k]));

      // Populate Class filter from data
      const classes = [...new Set(data.map(r => r[iClass]).filter(Boolean))].sort();
      classFilter.innerHTML = '<option value="">All Classes</option>' + classes.map(c => `<option>${c}</option>`).join('');

      // Apply filter
      const classSel = classFilter.value;
      const filtered = classSel ? data.filter(r => r[iClass] === classSel) : data;

      // Aggregate by student + class sums
      const byStudent = new Map();
      const classSums = Array(iCats.length).fill(0);
      const classCounts = Array(iCats.length).fill(0);

      for (const r of filtered) {
        const name = (r[iStudent] || '').trim();
        if (!name) continue;

        if (!byStudent.has(name)) {
          byStudent.set(name, { sums:Array(iCats.length).fill(0), counts:Array(iCats.length).fill(0) });
        }
        const rec = byStudent.get(name);

        iCats.forEach((col, i) => {
          const v = Number((r[col] || '').toString().trim());
          if (!Number.isNaN(v)) {
            rec.sums[i] += v; rec.counts[i] += 1;
            classSums[i] += v; classCounts[i] += 1;
          }
        });
      }

      const agg = [...byStudent.entries()].map(([student, rec]) => {
        const avgs = rec.sums.map((s, i) => rec.counts[i] ? s / rec.counts[i] : null);
        const nums = avgs.filter(x => x !== null);
        const overall = nums.length ? nums.reduce((a,b)=>a+b,0)/nums.length : null;
        return { student, avgs, overall };
      }).sort((a,b) => (a.overall ?? Infinity) - (b.overall ?? Infinity));

      // Class Average row
      const classAvgs = classSums.map((s, i) => classCounts[i] ? s / classCounts[i] : null);
      const classNums = classAvgs.filter(x => x !== null);
      const classOverall = classNums.length ? classNums.reduce((a,b)=>a+b,0)/classNums.length : null;

      // Render table
      thead.innerHTML = '';
      tbody.innerHTML = '';
      tfoot.innerHTML = '';

      ['Student', ...cats, 'Overall'].forEach(h => {
        const th = document.createElement('th'); th.textContent = h; thead.appendChild(th);
      });

      agg.forEach(r => {
        const tr = document.createElement('tr');
        function td(txt, style='') {
          const c = document.createElement('td');
          c.textContent = txt;
          if (style) c.style = style;
          tr.appendChild(c);
        }
        td(r.student);
        r.avgs.forEach(v => td(v==null?'—':(Math.round(v*100)/100).toFixed(2), tint(v)));
        td(r.overall==null?'—':(Math.round(r.overall*100)/100).toFixed(2), 'font-weight:700; ' + tint(r.overall));
        tbody.appendChild(tr);
      });

      // Footer: Class Average
      const trF = document.createElement('tr');
      function tdf(txt, style='') {
        const c = document.createElement('td');
        c.textContent = txt;
        if (style) c.style = style;
        trF.appendChild(c);
      }
      const label = classSel ? `Class Average (${classSel})` : 'Class Average (All)';
      tdf(label);
      classAvgs.forEach(v => tdf(v==null?'—':(Math.round(v*100)/100).toFixed(2), tint(v)));
      tdf(classOverall==null?'—':(Math.round(classOverall*100)/100).toFixed(2), 'font-weight:700; ' + tint(classOverall));
      tfoot.appendChild(trF);

      statusPill.textContent = 'Ready';
    } catch (e) {
      console.error('Dashboard error:', e);
      statusPill.textContent = 'Error';
      alert('Dashboard error: ' + (e.message || e));
    }
  }
</script>
</body>
</html>
